#!/usr/bin/env node
var github = require('../lib/github'),
    config = require('../lib/config'),
    repo = require('../lib/repo')[0],
    exec = require('exec-sync'),
    colors = require('colors'),
    columnizer = require('columnizer'),
    display = new columnizer(),
    comments = new columnizer(),
    editor = require('../lib/editor'),
    opts = require('nomnom').options({
        message: {
            abbr: 'm',
            help: 'message body'
        },
        title: {
            abbr: 't',
            help: 'message title'
        }
    }).parse();

var request = { user: repo.user, repo: repo.repo, labels: [] };

request.title = opts.title;
if (!opts.message) {
    editor(function (err, text) {
        if (text.trim().length === 0 && !request.title) {
            console.error('Refusing to create an empty issue');
            process.exit(1);
        }
        request.body = text;
        if (!request.title) request.title = text.slice(0, 15) + '...';
        makeRequest();
    });
} else {
    if (opts.message.trim().length === 0 && !request.title) {
        console.error('Refusing to create an empty issue');
        process.exit(1);
    }
    if (!request.title) request.title = text.slice(0, 15) + '...';
    request.body = opts.message;
    makeRequest();
}

function makeRequest() {
    github.issues.create(request, function (err, msg) {
        if (err) {
            console.error(err.message);
            process.exit(1);
        }
        console.log('Created issue #' + msg.number + ' ' + msg.html_url);
    });
}
