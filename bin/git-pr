#!/usr/bin/env node
var github = require('../lib/github'),
    config = require('../lib/config'),
    repo = require('../lib/repo')[0],
    exec = require('exec-sync'),
    colors = require('colors'),
    columnizer = require('columnizer'),
    display = new columnizer(),
    comments = new columnizer(),
    editor = require('../lib/editor'),
    opts = require('nomnom').options({
        target: {
            position: 0,
            help: 'branch to merge with'
        },
        message: {
            abbr: 'm',
            help: 'message body'
        },
        title: {
            abbr: 't',
            help: 'message title'
        }
    }).parse();

var request = { user: repo.user, repo: repo.repo };

var target = 'master';
if (opts.target) target = opts.target;

var output = exec('git status -sb', true);
if (!output.stdout) {
    console.error('This doesn\'t look like a git repo');
    process.exit(1);
}

var branch = output.stdout.split('\n')[0].replace('## ', '');
if (branch === 'master' && target === 'master') {
    console.error('You can\'t merge master into master..');
    process.exit(1);
}

if (branch === target) {
    console.error('You tried to merge %s into %s...', branch, target);
    process.exit(1);
}

request.head = repo.user + ':' + branch;
request.base = target;
request.title = opts.title || 'Merge ' + branch;
if (!opts.message) {
    editor(function (err, text) {
        request.body = text;
        makeRequest();
    });
} else {
    request.body = opts.message;
    makeRequest();
}

function makeRequest() {
    github.pullRequests.create(request, function (err, msg) {
        if (err) {
            console.error(err.message);
            process.exit(1);
        }
        console.log('Created pull request #' + msg.number + ' ' + msg.html_url);
    });
}
